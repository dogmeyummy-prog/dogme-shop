<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dogme | è´¦æˆ·ä¸­å¿ƒ ğŸ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Quicksand', sans-serif;
        background: #fdfcf9;
      }
      .active-press:active {
        transform: scale(0.95);
      }

      /* é»‘è‰² Toast */
      @keyframes floatIn {
        0% {
          transform: translate(-50%, 30px);
          opacity: 0;
        }
        100% {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }
      .toast-msg {
        position: fixed;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        background: #2d3436;
        color: white;
        padding: 16px 32px;
        border-radius: 20px;
        font-weight: 700;
        z-index: 10000;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        animation: floatIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }

      /* æ™ºèƒ½è¿”å›ç®­å¤´ï¼šç²¾å‡†å¯¹é½æ ¡æ­£ */
      .back-arrow-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f1f1;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .back-arrow-btn:hover {
        background: #f9f9f9;
        transform: translateX(-5px);
      }
      /* è§†è§‰åç§»ä¿®æ­£ï¼šSVG ç®­å¤´å½¢çŠ¶è§†è§‰é‡å¿ƒåå·¦ï¼Œå‘å·¦å¹³ç§» 1px è¾¾åˆ°ç‰©ç†å±…ä¸­ */
      .back-icon-fix {
        transform: translateX(-1px);
      }

      .login-card {
        background: white;
        border-radius: 45px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.03);
        border: 1px solid #fcfcfc;
      }
      .user-avatar {
        width: 90px;
        height: 90px;
        border-radius: 30px;
        object-fit: cover;
        margin: 0 auto 24px;
        border: 4px solid #f7f7f7;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      }

      input {
        background: #f7f7f7;
        border: 2px solid transparent;
        transition: all 0.3s;
      }
      input:focus {
        border-color: #ff8d36;
        background: white;
        outline: none;
      }
    </style>
  </head>
  <body class="p-6 flex flex-col min-h-screen">
    <nav class="max-w-xl mx-auto w-full flex justify-between items-center mb-12">
      <div class="flex items-center gap-4">
        <div onclick="smartBack()" class="back-arrow-btn active-press">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-gray-900 back-icon-fix"
          >
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
        </div>

        <div class="flex bg-gray-100 rounded-full p-1 shadow-inner text-[10px] font-black">
          <button
            onclick="switchLanguage('zh')"
            class="px-2 py-1 rounded-full hover:bg-white transition-all"
          >
            CN
          </button>
          <button
            onclick="switchLanguage('en')"
            class="px-2 py-1 rounded-full hover:bg-white transition-all"
          >
            EN
          </button>
          <button
            onclick="switchLanguage('fr')"
            class="px-2 py-1 rounded-full hover:bg-white transition-all"
          >
            FR
          </button>
        </div>
      </div>
    </nav>

    <main class="max-w-md mx-auto w-full flex-1 flex flex-col justify-center">
      <div class="login-card text-center">
        <img
          src="user.jpg"
          alt="User"
          class="user-avatar"
          onerror="this.src = 'https://via.placeholder.com/90?text=ğŸ¾'"
        />

        <h2 data-t="login_welcome" class="text-3xl font-black text-gray-900 mb-2">æ¬¢è¿å›æ¥</h2>
        <p data-t="login_subtitle" class="text-gray-400 font-bold mb-8 text-sm">
          è¯·è¾“å…¥é‚®ç®±è·å–ç™»å½•éªŒè¯ç 
        </p>

        <div class="space-y-4 text-left">
          <input
            type="email"
            id="login-email"
            data-t="email_placeholder"
            placeholder="æ‚¨çš„é‚®ç®±åœ°å€"
            class="w-full py-4 px-6 rounded-2xl font-bold"
          />
          <div class="flex gap-2">
            <input
              type="text"
              id="login-code"
              data-t="code_placeholder"
              placeholder="éªŒè¯ç "
              class="flex-1 py-4 px-6 rounded-2xl font-bold text-center tracking-widest"
            />
            <button
              id="send-code-btn"
              onclick="handleSendCode()"
              data-t="btn_get_code"
              class="px-6 bg-gray-900 text-white rounded-2xl font-black text-[10px] active-press"
            >
              è·å–
            </button>
          </div>
          <button
            onclick="handleLogin()"
            data-t="btn_login"
            class="w-full py-5 bg-orange-500 text-white rounded-[25px] font-black shadow-lg shadow-orange-100 mt-4 active-press"
          >
            å¼€å¯ Dogme ä¹‹æ—…
          </button>
        </div>
      </div>
    </main>

    <script src="i18n.js"></script>
    <script>
      const API_URL = '/api';

      function smartBack() {
        const ref = document.referrer;
        if (ref && ref.includes(window.location.hostname)) {
          window.history.back();
        } else {
          window.location.href = 'index.html';
        }
      }

      function showToast(m) {
        const old = document.querySelector('.toast-msg');
        if (old) old.remove();
        const t = document.createElement('div');
        t.className = 'toast-msg';
        t.innerText = m;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2500);
      }

      async function handleSendCode() {
        const email = document.getElementById('login-email').value.trim();
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®± ğŸ¾');
        const btn = document.getElementById('send-code-btn');
        btn.innerText = '...';
        btn.disabled = true;

        try {
          const res = await fetch(`${API_URL}/send-code`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          if (res.ok) {
            showToast('éªŒè¯ç å·²å‘å‡º âœ¨');
            startTimer();
          } else {
            const data = await res.json().catch(() => ({}));
            showToast(data.msg || 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±é…ç½®');
            btn.innerText = 'è·å–';
            btn.disabled = false;
          }
        } catch (e) {
          showToast('è¿æ¥äº‘ç«¯å¤±è´¥ âš ï¸');
          btn.innerText = 'é‡è¯•';
          btn.disabled = false;
        }
      }

      function startTimer() {
        const btn = document.getElementById('send-code-btn');
        let s = 60;
        const t = setInterval(() => {
          btn.innerText = `${s--}s`;
          if (s < 0) {
            clearInterval(t);
            btn.innerText = 'é‡å‘';
            btn.disabled = false;
          }
        }, 1000);
      }

      async function handleLogin() {
        const email = document.getElementById('login-email').value.trim();
        const code = document.getElementById('login-code').value.trim();
        if (!code) return showToast('è¯·è¾“å…¥éªŒè¯ç  ğŸ”‘');

        try {
          const res = await fetch(`${API_URL}/verify-code`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, code })
          });
          if (res.ok) {
            localStorage.setItem('dogme_user_email', email);
            localStorage.setItem('dogme_user_logged', 'true');
            showToast('æ¬¢è¿å›æ¥ ğŸ‰');
            setTimeout(() => {
              window.location.href = 'Log-in.html';
            }, 1000);
          } else {
            showToast('éªŒè¯ç é”™è¯¯ âŒ');
          }
        } catch (e) {
          showToast('ç™»å½•å¼‚å¸¸ âš ï¸');
        }
      }
    </script>

    <!-- Vercel Speed Insights -->
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
  </body>
</html>

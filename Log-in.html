<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dogme | ç™»å½• ğŸ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #fdfcf9; }
        .active-press:active { transform: scale(0.96); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .float-img { animation: float 4s ease-in-out infinite; }
    </style>
</head>
<body class="pb-20">
    <nav class="flex justify-between items-center px-6 md:px-8 py-4 md:py-6 sticky top-0 z-50 bg-white/70 backdrop-blur-xl border-b border-orange-50">
        <button onclick="location.href='index.html'" class="w-10 h-10 md:w-11 md:h-11 rounded-2xl bg-white shadow-sm flex items-center justify-center text-orange-500 active-press border border-orange-50">â®</button>
        <h1 class="text-lg md:text-xl font-black text-gray-900 tracking-tighter" data-t="login_title">ç™»å½•</h1>
        <div class="flex bg-gray-100 rounded-xl overflow-hidden">
            <button onclick="switchLanguage('zh')" id="lang-zh" class="px-2 py-1.5 text-[8px] md:text-[9px] font-black uppercase tracking-wider transition-colors">ä¸­æ–‡</button>
            <button onclick="switchLanguage('en')" id="lang-en" class="px-2 py-1.5 text-[8px] md:text-[9px] font-black uppercase tracking-wider transition-colors">EN</button>
            <button onclick="switchLanguage('fr')" id="lang-fr" class="px-2 py-1.5 text-[8px] md:text-[9px] font-black uppercase tracking-wider transition-colors">FR</button>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-4 md:px-6 mt-8 md:mt-16">
        <div class="text-center mb-8 md:mb-12">
            <div class="float-img inline-block mb-4 md:mb-6">
                <div class="w-20 h-20 md:w-24 md:h-24 bg-orange-50 rounded-3xl md:rounded-[35px] flex items-center justify-center text-4xl md:text-5xl border-4 border-white shadow-xl">ğŸ¾</div>
            </div>
            <h2 class="text-2xl md:text-3xl font-black text-gray-900 mb-2" data-t="login_welcome">æ¬¢è¿å›æ¥</h2>
            <p class="text-sm md:text-base text-gray-400 font-bold" data-t="login_subtitle">è¾“å…¥é‚®ç®±ç™»å½•æ‚¨çš„ Dogme è´¦æˆ·</p>
        </div>

        <div class="glass-card rounded-[35px] md:rounded-[45px] p-6 md:p-8 shadow-xl">
            <!-- é‚®ç®±è¾“å…¥ -->
            <div class="mb-4 md:mb-6">
                <label class="block text-xs md:text-sm font-black text-gray-700 mb-2 uppercase tracking-wider" data-t="login_email_label">é‚®ç®±åœ°å€</label>
                <input 
                    type="email" 
                    id="email-input" 
                    placeholder="your@email.com"
                    class="w-full px-4 py-3 md:py-4 rounded-2xl md:rounded-3xl border-2 border-gray-100 focus:border-orange-500 focus:outline-none font-bold text-sm md:text-base"
                >
            </div>

            <!-- éªŒè¯ç è¾“å…¥åŒºåŸŸï¼ˆåˆå§‹éšè—ï¼‰-->
            <div id="code-section" class="mb-4 md:mb-6 hidden">
                <label class="block text-xs md:text-sm font-black text-gray-700 mb-2 uppercase tracking-wider" data-t="login_code_label">éªŒè¯ç </label>
                <input 
                    type="text" 
                    id="code-input" 
                    placeholder="6ä½æ•°å­—"
                    maxlength="6"
                    class="w-full px-4 py-3 md:py-4 rounded-2xl md:rounded-3xl border-2 border-gray-100 focus:border-orange-500 focus:outline-none font-bold text-sm md:text-base"
                >
                <p class="text-xs text-gray-400 mt-2 font-bold" data-t="login_code_hint">è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼ŒéªŒè¯ç 5åˆ†é’Ÿå†…æœ‰æ•ˆ</p>
            </div>

            <!-- ä¸»æŒ‰é’® -->
            <button 
                id="main-btn" 
                onclick="handleGetCode()"
                class="w-full bg-gray-900 text-white py-3 md:py-4 rounded-2xl md:rounded-3xl font-black text-sm md:text-base uppercase tracking-wider active-press shadow-lg hover:bg-gray-800 transition-colors"
                data-t="btn_get_code"
            >
                è·å–éªŒè¯ç 
            </button>

            <!-- æç¤ºä¿¡æ¯ -->
            <p class="text-center text-xs text-gray-400 mt-4 md:mt-6 font-bold" data-t="login_privacy_hint">
                ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„ Dogme çš„æœåŠ¡æ¡æ¬¾ä¸éšç§æ”¿ç­–
            </p>
        </div>
    </main>

    <!-- Toast æç¤ºæ¡† -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-2xl font-bold text-sm shadow-2xl hidden z-50"></div>

    <script src="i18n.js"></script>
    <script>
        let currentEmail = '';
        let isCodeSent = false;

        function updateLanguageButtons() {
            const lang = localStorage.getItem('dogme_lang') || 'zh';
            ['zh', 'en', 'fr'].forEach(l => {
                const btn = document.getElementById(`lang-${l}`);
                if (l === lang) {
                    btn.classList.add('bg-gray-900', 'text-white');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('bg-gray-900', 'text-white');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), duration);
        }

        async function handleGetCode() {
            const email = document.getElementById('email-input').value.trim();
            const lang = localStorage.getItem('dogme_lang') || 'zh';
            const t = window.translations?.[lang] || window.translations?.['zh'];

            if (!email || !/\S+@\S+\.\S+/.test(email)) {
                showToast(t.login_email_invalid || 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            currentEmail = email;
            const mainBtn = document.getElementById('main-btn');
            mainBtn.disabled = true;
            mainBtn.textContent = t.login_sending || 'å‘é€ä¸­...';

            try {
                const response = await fetch('/api/server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'send-code', email })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(t.login_code_sent || 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼');
                    document.getElementById('code-section').classList.remove('hidden');
                    mainBtn.textContent = t.btn_login || 'å¼€å¯ Dogme ä¹‹æ—…';
                    mainBtn.setAttribute('data-t', 'btn_login');
                    mainBtn.onclick = handleLogin;
                    isCodeSent = true;
                    mainBtn.disabled = false;
                } else {
                    showToast(t.login_send_failed || 'å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    mainBtn.disabled = false;
                    mainBtn.textContent = t.btn_get_code || 'è·å–éªŒè¯ç ';
                }
            } catch (error) {
                console.error('[v0] Send code error:', error);
                showToast(t.login_network_error || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                mainBtn.disabled = false;
                mainBtn.textContent = t.btn_get_code || 'è·å–éªŒè¯ç ';
            }
        }

        async function handleLogin() {
            const code = document.getElementById('code-input').value.trim();
            const lang = localStorage.getItem('dogme_lang') || 'zh';
            const t = window.translations?.[lang] || window.translations?.['zh'];

            if (!code || code.length !== 6) {
                showToast(t.login_code_invalid || 'è¯·è¾“å…¥6ä½éªŒè¯ç ');
                return;
            }

            const mainBtn = document.getElementById('main-btn');
            mainBtn.disabled = true;
            mainBtn.textContent = t.login_verifying || 'éªŒè¯ä¸­...';

            try {
                const response = await fetch('/api/server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'verify-code', 
                        email: currentEmail, 
                        code 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('dogme_user_logged', 'true');
                    localStorage.setItem('dogme_user_email', currentEmail);
                    localStorage.setItem('dogme_user_exp', '0');
                    
                    showToast(t.login_success || 'ç™»å½•æˆåŠŸï¼');
                    setTimeout(() => {
                        window.location.href = 'user.html';
                    }, 1000);
                } else {
                    showToast(data.msg || t.login_verify_failed || 'éªŒè¯å¤±è´¥');
                    mainBtn.disabled = false;
                    mainBtn.textContent = t.btn_login || 'å¼€å¯ Dogme ä¹‹æ—…';
                }
            } catch (error) {
                console.error('[v0] Verify code error:', error);
                showToast(t.login_network_error || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                mainBtn.disabled = false;
                mainBtn.textContent = t.btn_login || 'å¼€å¯ Dogme ä¹‹æ—…';
            }
        }

        window.onload = () => {
            const isLogged = localStorage.getItem('dogme_user_logged');
            if (isLogged === 'true') {
                window.location.href = 'user.html';
                return;
            }
            updateLanguageButtons();
            const savedLang = localStorage.getItem('dogme_lang') || 'zh';
            switchLanguage(savedLang);
        };

        window.translations = translations;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dogme Pay | è®¢å•è¯¦æƒ… ğŸ¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background: #fdfcf9; }
        .pay-card { background: white; border-radius: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .active-press:active { transform: scale(0.95); }
        .item-row { border-bottom: 1px dashed #f0f0f0; }
        .success-anim { animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes scaleIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen py-10 px-6">

    <div class="max-w-md mx-auto">
        <div class="flex items-center gap-4 mb-8">
            <button onclick="history.back()" class="w-12 h-12 bg-white rounded-2xl shadow-sm flex items-center justify-center text-gray-800 active-press border border-orange-50">â®</button>
            <h2 class="text-2xl font-black text-gray-900 tracking-tight">ç¡®è®¤è®¢å•</h2>
        </div>

        <div class="pay-card p-8 mb-6">
            <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">æ‚¨çš„è´­ç‰©æ¸…å• Items</h3>
            
            <div id="items-list" class="space-y-4 mb-8">
                </div>

            <div class="bg-gray-50 rounded-[30px] p-6 space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="font-bold text-gray-400">å•†å“å°è®¡ (Subtotal)</span>
                    <span id="subtotal-price" class="font-black text-gray-800">$0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="font-bold text-gray-400">ç¨è´¹ Sales Tax (HST/GST)</span>
                    <span id="tax-price" class="font-black text-gray-800">$0.00</span>
                </div>
                <div class="h-[1px] bg-gray-200 my-2"></div>
                <div class="flex justify-between items-end">
                    <span class="font-black text-gray-900">å®ä»˜æ€»é¢ (Total)</span>
                    <h1 id="total-amount" class="text-3xl font-black text-orange-500 tracking-tighter">$0.00</h1>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <button onclick="handleRealPay()" id="confirm-pay" class="w-full py-5 bg-gray-900 text-white rounded-[25px] font-black text-lg active-press shadow-xl shadow-gray-200">
                ğŸš€ ç«‹å³çœŸå®æ”¯ä»˜
            </button>
            <p class="text-center text-[10px] text-gray-300 font-bold uppercase tracking-widest">Powered by Stripe Security ğŸ¾</p>
        </div>
    </div>

    <div id="success-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center hidden">
        <div class="success-anim text-center">
            <div class="text-8xl mb-6">âœ¨</div>
            <h2 class="text-3xl font-black text-gray-900 mb-2">æ”¯ä»˜å®Œæˆ!</h2>
            <p id="exp-gain-msg" class="text-orange-500 font-bold mb-10">è·å¾—ç»éªŒå¥–åŠ± ğŸ¾</p>
            <button onclick="location.href='index.html'" class="px-12 py-4 bg-gray-900 text-white rounded-2xl font-black active-press">å›åˆ°ä¸»é¡µ</button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒä»·æ ¼è®¡ç®—é€»è¾‘
        window.onload = () => {
            const cart = JSON.parse(localStorage.getItem('dogme_cart') || '[]');
            const itemsContainer = document.getElementById('items-list');
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = `<p class="text-gray-400 font-bold py-4">è´­ç‰©è½¦æ˜¯ç©ºçš„ ğŸ¾</p>`;
                return;
            }

            // 1. æ¸²æŸ“å•†å“
            let totalAfterTax = 0;
            itemsContainer.innerHTML = cart.map(item => {
                totalAfterTax += item.price; // å‡è®¾å­˜å‚¨çš„æ˜¯ç¨åä»·
                return `
                    <div class="flex justify-between items-center py-2 item-row">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-orange-50 rounded-xl flex items-center justify-center text-xl">ğŸ¦´</div>
                            <div>
                                <span class="block font-black text-gray-800 text-sm">${item.name}</span>
                                <span class="block text-[9px] text-gray-400 font-bold uppercase">Qty: 1</span>
                            </div>
                        </div>
                        <span class="font-black text-gray-800">$${item.price.toFixed(2)}</span>
                    </div>
                `;
            }).join('');

            // 2. æ‹†è§£ä»·æ ¼ (å‡è®¾ç¨ç‡ 13%)
            const taxRate = 0.13;
            // åŸä»· = ç¨åä»· / (1 + ç¨ç‡)
            const subtotal = totalAfterTax / (1 + taxRate);
            const taxAmount = totalAfterTax - subtotal;

            document.getElementById('subtotal-price').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax-price').innerText = `$${taxAmount.toFixed(2)}`;
            document.getElementById('total-amount').innerText = `$${totalAfterTax.toFixed(2)}`;
        };

        // çœŸå®æ”¯ä»˜é€»è¾‘å¯¹æ¥
        async function handleRealPay() {
            const btn = document.getElementById('confirm-pay');
            const totalStr = document.getElementById('total-amount').innerText.replace('$', '');
            const email = localStorage.getItem('dogme_user_email') || 'guest@dogme.com';
            
            btn.innerText = "âš¡ï¸ æ­£åœ¨è¿æ¥é“¶è¡Œ...";
            btn.disabled = true;

            try {
                // è°ƒç”¨ä½ åœ¨ server.js ä¸­å®ç°çš„æ¥å£
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: parseFloat(totalStr),
                        email: email
                    })
                });

                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url; // è·³è½¬è‡³ Stripe
                } else {
                    throw new Error("API Error");
                }
            } catch (e) {
                alert("æ”¯ä»˜åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Vercel å¯†é’¥é…ç½® ğŸ¾");
                btn.innerText = "ğŸ›’ ç«‹å³æ”¯ä»˜";
                btn.disabled = false;
            }
        }

        // æ£€æµ‹æ”¯ä»˜è¿”å›ç»“æœ
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('status') === 'success') {
            const paidAmount = parseFloat(urlParams.get('amount') || '0');
            localStorage.setItem('dogme_has_order', 'true');
            
            // ç»éªŒå¥–åŠ±é€»è¾‘
            let currentExp = parseInt(localStorage.getItem('dogme_user_exp') || '0');
            localStorage.setItem('dogme_user_exp', currentExp + Math.floor(paidAmount));
            
            // æ¸…ç†
            localStorage.removeItem('dogme_cart');
            
            document.getElementById('exp-gain-msg').innerText = `è·å¾— +${Math.floor(paidAmount)} ç»éªŒå€¼ ğŸ¾`;
            document.getElementById('success-overlay').classList.remove('hidden');
        }
    </script>
</body>
</html>
